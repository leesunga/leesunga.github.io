<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>option test</title>
    <style>
      body * {margin:0;padding:0;font-size:1em;line-height:2em;}
    </style>
  </head>
  <body>
    <div data-role="optionContainer"></div>
    
    <script id="optionTemplate" type="text/x-handlebars-template">
      {{#optionInfo}}
        {{#if isSelectBox}}
        <select data-role="optionBox" data-depth="{{ depth }}"{{#if isDisabled}}disabled{{/if}}>
          <option value="">{{ title }}</option>
          {{#options}}
          <option value="{{ value }}"{{isSelected ../selectIndex @index}}>{{ title }}</option>
          {{/options}}
        </select>
        {{/if}}
        
        {{#if isTextBox}}
        <input type="text" value="{{ value }}" placeholder="{{ title }}" data-role="optionBox" data-depth="{{ depth }}" />
        {{/if}}
      {{/optionInfo}}
    </script>
    <script src="js/jquery-1.12.1.min.js"></script>
    <script src="js/handlebars.min.js"></script>
    <script src="js/redux.js"></script>
    <script>
    const optionContainer = $('[data-role=optionContainer]');
    const optionTemplate = Handlebars.compile($('#optionTemplate').html());
    
    Handlebars.registerHelper('isSelected', function (selectIndex, index, options) {
      let listIndex = index + 1;
      if (selectIndex === listIndex) {
        return new Handlebars.SafeString(' selected');
      } else {
        return '';
      }
    });
    
    const initState = {
      changeDepth: 1,
      isLastDepth: false,
      depth: 1,
      // kind: ['첫번째', '두번째', '세번째', '네번째'],
      optionInfo: [{
        isSelectBox: true,
        selectIndex: 0,
        isDisabled: false,
        depth: 1,
        title: '첫번째',
        value: '',
        options: [
          {
            value: '1',
            title: '1',
            contents: {
              isSelectBox: true,
              selectIndex: 0,
              isDisabled: false,
              depth: 2,
              title: '두번째',
              value: '',
              options: [
                {
                  value: '1_1',
                  title: '1_1',
                  contents: {
                    isSelectBox: true,
                    selectIndex: 0,
                    isDisabled: false,
                    depth: 3,
                    title: '세번째?',
                    value: '',
                    options: [
                      {
                        value: '1_1_1',
                        title: '1_1_1',
                      },
                      {
                        value: '1_1_2',
                        title: '1_1_2',
                        contents: {
                          isTextBox: true,
                          depth: 4,
                          title: '네번째',
                          value: '',
                        },
                      }
                    ],
                  },
                },
                {
                  value: '1_2',
                  title: '1_2',
                }
              ],
            },
          },
          {
            value: '2',
            title: '2',
            contents: {
              isSelectBox: true,
              selectIndex: 0,
              isDisabled: false,
              depth: 2,
              title: '두번째',
              value: '',
              options: [
                {
                  value: '2_1',
                  title: '2_1',
                },
                {
                  value: '2_2',
                  title: '2_2',
                }
              ],
            }
          },
          {
            value: '3',
            title: '3',
          }
        ],
      }],
    };
    
    const reducer = (state = initState, action) => {
      
      const pushOptionBox = (newState, action) => {
        
        const actionDepth = parseInt(action.changeDepth) || 1;
        
        if (newState.depth > 1 && newState.kind) {
          for (let i = newState.optionInfo.length; i < newState.depth; i++) {
            newState.optionInfo.push({
              isSelectBox: true,
              selectIndex: 0,
              depth: 1,
              title: newState.kind[i] || '선택',
              value: '',
              isDisabled: true,
            });
          }
        }
        
        return newState;
      }
      
      switch (action.type) {
        
        case 'OPTION_INIT':
          
          if (state.depth > 1) {
            
            const actionDepth = parseInt(action.changeDepth) || 1;
            const newState = Object.assign({}, state, {optionInfo: [
              ...state.optionInfo.slice(0, actionDepth - 1),
              Object.assign(state.optionInfo[actionDepth - 1], {title: state.kind[actionDepth - 1]})
            ]});
            
            pushOptionBox(newState, action);
            
            return newState;
            
          } else {
            
            return state;
          }
          
        
        case 'OPTION_CHANGE':
          const actionDepth = parseInt(action.changeDepth);
          let newState = Object.assign({}, state, 
            {changeDepth: actionDepth},
            {
              optionInfo: [
                ...state.optionInfo.slice(0, actionDepth - 1),
                Object.assign({}, state.optionInfo[actionDepth - 1], {selectIndex: action.index, value: action.value}),
              ]
            }
          );
          
          if (action.index) {
            const myOptions = newState.optionInfo[actionDepth - 1].options[action.index - 1] || {};            
            
            newState.isLastDepth = false;
            
            if (myOptions.contents) {
              newState.optionInfo.push(myOptions.contents);
            } else {
              newState.isLastDepth = true;
            }
          }
          
          pushOptionBox(newState, action);
          
          return newState;
          
        default:
          return state;
      }
    }
    
    const store = Redux.createStore(reducer);

    const render = () => {
      // console.log('getState', store.getState());
      optionContainer.html(optionTemplate(store.getState()));
      
      if (store.getState().isLastDepth) {
        optionContainer.append('<div>선택 완료!</div>')
      }
    };
    
    store.subscribe(render);
    store.dispatch({ type: 'OPTION_INIT'});
    
    optionContainer.on('change', (e) => {
      store.dispatch({ type: 'OPTION_CHANGE', changeDepth: e.target.getAttribute('data-depth'), index: e.target.selectedIndex, value: e.target.value});
    });

    </script>
  </body>
</html>